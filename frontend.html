<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiative Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .left-panel, .right-panel {
            flex: 1;
        }
        .color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #000;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        .current-turn {
            font-weight: bold;
            background-color: #e0e0e0;
            border: 2px solid #4CAF50;
        }
        .current-turn-marker {
            background-color: #4CAF50;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
        form {
            margin-bottom: 20px;
        }
        input, button, select {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Initiative Tracker</h1>
    <div class="container">
        <div class="left-panel">
            <h2>Initiative Order</h2>
            <ul id="initiativeList"></ul>
            <form id="initiativeForm">
                <input type="text" id="name" placeholder="Name" required>
                <input type="number" id="initiative" placeholder="Initiative" required>
                <select id="colorSelect">
                    <option value="">Select Color</option>
                </select>
                <button type="submit">Add to Initiative</button>
            </form>
            <button id="nextTurnBtn">Next Turn</button>
        </div>
        <div class="right-panel">
            <h2>Connected Devices</h2>
            <ul id="deviceList"></ul>
            <div id="deviceColor"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        const initiativeForm = document.getElementById('initiativeForm');
        const nameInput = document.getElementById('name');
        const initiativeInput = document.getElementById('initiative');
        const colorSelect = document.getElementById('colorSelect');
        const initiativeList = document.getElementById('initiativeList');
        const deviceList = document.getElementById('deviceList');
        const deviceColor = document.getElementById('deviceColor');
        const nextTurnBtn = document.getElementById('nextTurnBtn');

        let initiatives = [];
        let connectedDevices = {};
        let myColor = null;
        let myDeviceId = null;
        let isHost = false;
        let currentTurnId = null;

        async function connectDevice() {
            try {
                const response = await fetch(`${API_URL}/connect`);
                if (response.ok) {
                    const data = await response.json();
                    myDeviceId = data.device_id;
                    myColor = data.color;
                    isHost = data.isHost;
                    deviceColor.innerHTML = `<div class="color-box" style="background-color: ${myColor};"></div>Your device color: ${myColor}${isHost ? ' (Host)' : ''}`;
                    fetchInitiatives();
                    updateConnectedDevices();
                }
            } catch (error) {
                console.error('Failed to connect device:', error);
            }
        }

        async function fetchInitiatives() {
            try {
                const response = await fetch(`${API_URL}/initiatives`);
                if (response.ok) {
                    initiatives = await response.json();
                    console.log("Fetched initiatives:", initiatives);
                    updateInitiativeList();
                } else {
                    console.error("Failed to fetch initiatives:", await response.text());
                }
            } catch (error) {
                console.error('Failed to fetch initiatives:', error);
            }
        }

        async function addInitiative(name, initiative, color) {
            const newInitiative = { 
                name, 
                initiative: parseInt(initiative, 10), 
                color: color
            };
            try {
                const response = await fetch(`${API_URL}/initiatives`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newInitiative),
                });
                if (response.ok) {
                    await fetchInitiatives();
                }
            } catch (error) {
                console.error('Failed to add initiative to server:', error);
            }
        }

        async function deleteInitiative(id) {
            try {
                const response = await fetch(`${API_URL}/initiatives/${id}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    await fetchInitiatives();
                }
            } catch (error) {
                console.error('Failed to delete initiative:', error);
            }
        }

        async function updateConnectedDevices() {
            try {
                const response = await fetch(`${API_URL}/devices`);
                if (response.ok) {
                    connectedDevices = await response.json();
                    updateDeviceList();
                    updateColorSelect();
                }
            } catch (error) {
                console.error('Failed to get connected devices:', error);
            }
        }

        function updateColorSelect() {
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            Object.entries(connectedDevices).forEach(([id, data]) => {
                const option = document.createElement('option');
                option.value = data.color;
                option.textContent = `${id === myDeviceId ? 'Your' : 'Player'} Color ${data.isHost ? '(Host)' : ''}`;
                option.style.backgroundColor = data.color;
                colorSelect.appendChild(option);
            });
        }

        async function getCurrentTurn() {
            try {
                const response = await fetch(`${API_URL}/current-turn`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("Current turn data:", data);
                    currentTurnId = data.id;
                    updateInitiativeList();
                } else {
                    console.error("Failed to get current turn:", await response.text());
                }
            } catch (error) {
                console.error('Failed to get current turn:', error);
            }
        }

        function updateInitiativeList() {
            console.log("Updating initiative list. Current turn ID:", currentTurnId);
            initiativeList.innerHTML = '';
            initiatives.forEach((item) => {
                const li = document.createElement('li');
                li.className = item.id === currentTurnId ? 'current-turn' : '';
                li.innerHTML = `
                    <div class="color-box" style="background-color: ${item.color};"></div>
                    <span>${item.name} (${item.initiative})</span>
                    ${item.id === currentTurnId ? '<span class="current-turn-marker">Current Turn</span>' : ''}
                    <button class="delete-btn" data-id="${item.id}">Delete</button>
                `;
                initiativeList.appendChild(li);
            });
        }

        function updateDeviceList() {
            deviceList.innerHTML = '';
            Object.entries(connectedDevices).forEach(([id, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="color-box" style="background-color: ${data.color};"></div>
                    ${id === myDeviceId ? 'You' : 'Player'} ${data.isHost ? '(Host)' : ''}
                `;
                deviceList.appendChild(li);
            });
        }

        async function nextTurn() {
            console.log("Next turn button clicked");
            try {
                const response = await fetch(`${API_URL}/next-turn`, {
                    method: 'POST',
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log("Next turn response:", data);
                    currentTurnId = data.id;
                    await fetchInitiatives();
                    updateInitiativeList();
                } else {
                    console.error("Failed to update turn:", await response.text());
                }
            } catch (error) {
                console.error('Failed to update turn:', error);
            }
        }

        initiativeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = nameInput.value;
            const initiative = initiativeInput.value;
            const color = colorSelect.value;
            if (!color) {
                alert('Please select a color');
                return;
            }
            await addInitiative(name, initiative, color);
            initiativeForm.reset();
        });

        initiativeList.addEventListener('click', async function(e) {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.getAttribute('data-id');
                await deleteInitiative(id);
            }
        });

        // Ensure this event listener is correctly set up
        document.addEventListener('DOMContentLoaded', () => {
            if (nextTurnBtn) {
                nextTurnBtn.addEventListener('click', nextTurn);
                console.log("Next turn button listener added");
            } else {
                console.error("Next turn button not found");
            }
        });

        // Connect device when page loads
        connectDevice();

        // Periodically update connected devices and current turn
        setInterval(() => {
            updateConnectedDevices();
            getCurrentTurn();
        }, 5000);

        // Disconnect device when page is closed
        window.addEventListener('beforeunload', async () => {
            if (myDeviceId) {
                try {
                    await fetch(`${API_URL}/disconnect/${myDeviceId}`, { method: 'POST' });
                } catch (error) {
                    console.error('Failed to disconnect device:', error);
                }
            }
        });
    </script>
</body>
</html>